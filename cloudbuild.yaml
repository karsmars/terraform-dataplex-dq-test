steps:
  - name: 'hashicorp/terraform:light'
    id: 'validate-format'
    entrypoint: sh
    args:
      - -c
      - |
        echo "ğŸ§ª Initializing Terraform"
        terraform init

        echo "ğŸ” Validating Terraform configuration"
        terraform validate

        echo "ğŸ§¼ Checking Terraform formatting"
        if ! terraform fmt -check -diff -recursive; then
          echo ""
          echo "âŒ Terraform files are not properly formatted."
          echo "ğŸ’¡ Run 'terraform fmt' locally and push the changes."
          exit 1
        else
          echo "âœ… Formatting looks good"
        fi

  - name: 'hashicorp/terraform:light'
    id: 'plan-and-apply-on-main'
    entrypoint: sh
    args:
      - -c
      - |
        if [ "$BRANCH_NAME" = "main" ]; then
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan
        else
          echo "ğŸ” Not on main branch â€” skipping plan/apply"
        fi

options:
  logging: CLOUD_LOGGING_ONLY
