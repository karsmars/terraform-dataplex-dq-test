steps:
  - name: 'hashicorp/terraform:light'
    id: 'validate-format'
    entrypoint: sh
    args:
      - -c
      - |
        echo "🧪 Initializing Terraform"
        terraform init

        echo "🔍 Validating Terraform configuration"
        terraform validate

        echo "🧼 Checking Terraform formatting"
        if ! terraform fmt -check -diff -recursive; then
          echo ""
          echo "❌ Terraform files are not properly formatted."
          echo "💡 Run 'terraform fmt' locally and push the changes."
          exit 1
        else
          echo "✅ Formatting looks good"
        fi

  - name: 'hashicorp/terraform:light'
    id: 'plan-and-apply-on-main'
    entrypoint: sh
    args:
      - -c
      - |
        if [ "$BRANCH_NAME" = "main" ]; then
          terraform plan -out=tfplan
          terraform apply -auto-approve tfplan
        else
          echo "🔁 Not on main branch — skipping plan/apply"
        fi

options:
  logging: CLOUD_LOGGING_ONLY
